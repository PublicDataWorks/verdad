# Slack & Email Notifications

VERDAD uses a combined notification system to keep analysts and researchers informed about collaboration activity and detection events. The system leverages **Resend** for email delivery and a **Slack Email Integration** to bridge communications into team channels.

## Configuration

To enable notifications, you must configure the following environment variables in your server environment:

| Variable | Description |
| :--- | :--- |
| `RESEND_API_KEY` | Your API key from [Resend](https://resend.com/). |
| `SLACK_NOTIFICATION_EMAIL` | The unique email address generated by your Slack "Email" integration. |
| `SUPABASE_URL` | Used to fetch email templates. |
| `SUPABASE_SERVICE_ROLE_KEY` | Used to fetch email templates. |

## Notification Channels

### Email (via Resend)
Direct email notifications are sent for user-specific events, such as being @mentioned in a snippet discussion. These emails are sent from `Verdad <notifications@verdad.app>`.

### Slack Integration
VERDAD communicates with Slack via an email bridge. To set this up:
1. In Slack, add the **Email** app to your workspace.
2. Create a configuration that posts to your desired channel (e.g., `#disinfo-alerts`).
3. Copy the generated email address and assign it to the `SLACK_NOTIFICATION_EMAIL` environment variable.

## Triggered Events

The platform automatically dispatches notifications for the following collaborative actions within the snippet review interface:

| Event Type | Trigger | Content Included |
| :--- | :--- | :--- |
| **Mention** | When a user is @tagged in a comment. | Room ID, actor name, and link to snippet. |
| **Comment** | When a new comment is added to a snippet thread. | The body of the comment and a direct link. |
| **Edit** | When an existing comment is modified. | Comparison of the original vs. edited text. |
| **Delete** | When a comment is removed. | Identification of the deleted comment and actor. |

### Usage Example (Internal)

While notifications are usually triggered automatically by Liveblocks webhooks, the `slackService` provides a structured interface for sending alerts:

```typescript
import { sendSlackNotification } from './services/slackService';

await sendSlackNotification({
    type: 'comment',
    actor: 'Lead Analyst',
    roomId: 'snippet-uuid-123',
    content: 'This broadcast contains high-confidence disinformation regarding local elections.'
});
```

## Email Templates

Notification content is managed dynamically via the `email_template` table in your Supabase database. This allows you to update the branding or messaging of alerts without redeploying the server.

The system specifically looks for a template named `mention_notification`. Templates support the following placeholders:

*   `{{subject}}`: The notification's subject line.
*   `{{commentBody}}`: The text content of the comment.
*   `{{roomId}}`: The unique ID of the audio snippet.
*   `{{link}}`: A direct URL to the snippet on the VERDAD front-end.

### Template Management
To modify the notification look and feel, update the `template_content` column in the `email_template` table:

```sql
-- Example: Updating the mention template
UPDATE email_template 
SET template_content = '<html><body>Hi! You were mentioned in: {{commentBody}} <a href="{{link}}">View Snippet</a></body></html>' 
WHERE template_name = 'mention_notification';
```
